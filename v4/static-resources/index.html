<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Swoole support for Mezzio">  
    <link rel="canonical" href="https://docs.mezzio.dev/mezzio-swoole/v4/static-resources/">
    <link rel="shortcut icon" href="https://docs.laminas.dev/img/trademark-laminas-foundation-rgb.svg">

    <title>Static Resources - mezzio-swoole - Laminas Docs</title>

    <link rel="stylesheet" href="https://docs.laminas.dev/css/styles.css">
    
</head>
<body id="page-top" class="mezzio" data-spy="scroll" data-target=".toc" data-offset="20">

    
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container">
        
        <a class="logo-link navbar-brand" href="https://getlaminas.org/" data-tooltip data-placement="bottom" title="Go to the Laminas homepage">
            <img src="https://docs.laminas.dev/img/laminas-foundation-white.svg" height="28" alt="Laminas">
        </a>
        <a class="navbar-title" href="https://docs.laminas.dev/" data-tooltip data-placement="bottom" title="Go to the Laminas Documentation">
            Documentation
        </a>

        
        <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarSupportedContent">

            
            <ul class="navbar-nav ml-auto">
                <li class="nav-item">
                    <div class="dropdown sub-project-selector">
                        <a class="dropdown-toggle nav-link" data-toggle="dropdown" aria-expanded="false">
                            All Docs
                        </a>
                        <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                            <a href="https://docs.mezzio.dev/" class="dropdown-item">
                                <div class="row align-items-center">
                                    <div class="col-md-4 col-sm-12">
                                        <img src="https://docs.laminas.dev/img/laminas-mezzio-rgb.svg">
                                    </div>
                                    <div class="col-md-8 col-sm-12">
                                        <strong>Mezzio</strong><br>
                                        PSR-15 Middleware in Minutes
                                    </div>
                                </div>
                            </a>
                            <a href="https://docs.laminas.dev/components/" class="dropdown-item">
                                <div class="row align-items-center">
                                    <div class="col-md-4 col-sm-12">
                                        <img src="https://docs.laminas.dev/img/laminas-components-rgb.svg">
                                    </div>
                                    <div class="col-md-8 col-sm-12">
                                        <strong>Components</strong><br>
                                        Components for Enterprise Applications
                                    </div>
                                </div>
                            </a>
                            <a href="https://docs.laminas.dev/mvc" class="dropdown-item">
                                <div class="row align-items-center">
                                    <div class="col-md-4 col-sm-12">
                                        <img src="https://docs.laminas.dev/img/laminas-mvc-rgb.svg">
                                    </div>
                                    <div class="col-md-8 col-sm-12">
                                        <strong>MVC</strong><br>
                                        MVC for Enterprise Applications
                                    </div>
                                </div>
                            </a>
                            <a href="https://api-tools.getlaminas.org/documentation" class="dropdown-item">
                                <div class="row align-items-center">
                                    <div class="col-md-4 col-sm-12">
                                        <img src="https://docs.laminas.dev/img/laminas-api-tools-rgb.svg">
                                    </div>
                                    <div class="col-md-8 col-sm-12">
                                        <strong>API Tools</strong><br>
                                        Build RESTful APIs in Minutes
                                    </div>
                                </div>
                            </a>
                            <div class="dropdown-divider"></div>
                            <a class="dropdown-item dropdown-item--secondardy" href="https://docs.laminas.dev/migration/">
                                <div class="row align-items-center">
                                    <div class="col-md-8 offset-md-4 col-sm-12">
                                        Migration to Laminas
                                    </div>
                                </div>
                            </a>
                            <a class="dropdown-item dropdown-item--secondardy" href="https://docs.laminas.dev/tutorials/">
                                <div class="row align-items-center">
                                    <div class="col-md-8 offset-md-4 col-sm-12">
                                        Tutorials
                                    </div>
                                </div>
                            </a>
                        </div>
                    </div>
                </li>
                <li class="nav-item">
                    <a href="https://getlaminas.org/participate" class="nav-link">Community</a>
                </li>
            </ul>

            
            
                <div class="d-block d-sm-none">
                    
    <div class="subnavigation hidden-print">
        <h4 class="subnavigation__title">
            <a href="../..">mezzio-swoole</a>
        </h4>

        <h5 class="subnavigation__subtitle">Table of Contents</h5>

        <ul class="subnavigation__list">
            

                
                
                    
                        
    <li class="subnavigation__list-item ">
        <a href="../intro/" class="subnavigation__link">Introduction</a>
    </li>

                    
                        
    <li class="subnavigation__list-item">
        <span class="subnavigation__headline">Reference</span>
        <ul class="subnavigation__list">
            
                
    <li class="subnavigation__list-item ">
        <a href="../events/" class="subnavigation__link">Swoole HTTP Server Events</a>
    </li>

            
                
    <li class="subnavigation__list-item subnavigation__list-item--active">
        <a href="./" class="subnavigation__link">Static Resources</a>
    </li>

            
                
    <li class="subnavigation__list-item ">
        <a href="../logging/" class="subnavigation__link">Logging</a>
    </li>

            
                
    <li class="subnavigation__list-item ">
        <a href="../async-tasks/" class="subnavigation__link">Async Tasks</a>
    </li>

            
                
    <li class="subnavigation__list-item ">
        <a href="../table/" class="subnavigation__link">Using Swoole Tables</a>
    </li>

            
                
    <li class="subnavigation__list-item ">
        <a href="../hot-code-reload/" class="subnavigation__link">Hot Code Reloading</a>
    </li>

            
                
    <li class="subnavigation__list-item ">
        <a href="../command-line/" class="subnavigation__link">Command Line Tooling</a>
    </li>

            
                
    <li class="subnavigation__list-item ">
        <a href="../how-it-works/" class="subnavigation__link">How it works</a>
    </li>

            
                
    <li class="subnavigation__list-item ">
        <a href="../considerations/" class="subnavigation__link">Considerations when using Swoole</a>
    </li>

            
        </ul>
    </li>

                    
                        
    <li class="subnavigation__list-item">
        <span class="subnavigation__headline">Cookbook</span>
        <ul class="subnavigation__list">
            
                
    <li class="subnavigation__list-item ">
        <a href="../cookbook/static-resource-listener-removal/" class="subnavigation__link">Removing the StaticResourceRequestListener</a>
    </li>

            
                
    <li class="subnavigation__list-item ">
        <a href="../cookbook/swoole-not-starting/" class="subnavigation__link">Swoole-based server always returns home page</a>
    </li>

            
        </ul>
    </li>

                    
                        
    <li class="subnavigation__list-item ">
        <a href="../migration/" class="subnavigation__link">Migration</a>
    </li>

                    
                
            

                
                

                    
                    
                
            

                
                

                    
                    
                
            

                
                

                    
                    
                
            
        </ul>
    </div>

                </div>
            

            
            <div class="d-block d-sm-none">
                <div class="component-selector">
    
    <h5 class="component-selector__subtitle">Find documentation…</h5>
    <select class="form-control component-selector__control">
        <option value="/">Overview</option>
        <optgroup label="Components"></optgroup>
    </select>
</div>
            </div>
        </div>
    </div>
</nav>

    
    <header class="header">
    <div class="container">
        <div class="row">

            
            <div class="col-8">
                <h1 class="header__title">
                    Mezzio

                    
                        <small class="header__subtitle">mezzio-swoole</small>
                    
                </h1>
            </div>

            
            <div class="col-4 text-right">
                
                    
<div class="version-selector">
    <div class="btn-group">
        <button type="button" class="btn dropdown-toggle" data-toggle="dropdown" data-display="static" aria-haspopup="true" aria-expanded="false" id="version-selector-dropdown">
            
                v4
            
        </button>
        <div class="dropdown-menu dropdown-menu-right dropdown-menu-lg-left" aria-labelledby="version-selector-dropdown">
            
                
                    <a href="../intro/" class="dropdown-item active">
                        
                            v4 (latest)
                        
                    </a>
                
            
                
                    <a href="../../v3/intro/" class="dropdown-item">
                        
                            v3
                        
                    </a>
                
            
                
                    <a href="../../v2/intro/" class="dropdown-item">
                        
                            v2
                        
                    </a>
                
            
                
                    <a href="../../v1/intro/" class="dropdown-item">
                        
                            v1
                        
                    </a>
                
            
        </div>
    </div>
</div>


                    <a href="#" class="header__link header__link--search" data-toggle="modal" data-target="#mkdocs_search_modal" title="Open search">
                        <i class="fa fa-search"></i> Search
                    </a>
                    <a href="https://github.com/mezzio/mezzio-swoole/" class="header__link header__link--github" title="Go to repository of mezzio-swoole">
                        <i class="fa fa-github"></i> GitHub
                    </a>
                
            </div>
        </div>
    </div>
</header>

    
    <div class="container">
        <div class="row">
            <div class="col-md-9 col-sm-12 content" role="main">
                
                
                    
    

    
    
        <div class="toc">
            <h6 class="toc__headline">On this page</h6>
            <ul class="toc__list">
                
                    <li class="toc__entry">
                        <a href="#middleware" class="toc__link nav-link">Middleware</a>
                    </li>
                
                    <li class="toc__entry">
                        <a href="#configuration" class="toc__link nav-link">Configuration</a>
                    </li>
                
                    <li class="toc__entry">
                        <a href="#writing-middleware" class="toc__link nav-link">Writing Middleware</a>
                    </li>
                
                    <li class="toc__entry">
                        <a href="#alternative-static-resource-handlers" class="toc__link nav-link">Alternative static resource handlers</a>
                    </li>
                
                    <li class="toc__entry">
                        <a href="#example-alternate-static-resource-handler-staticmappedresourcehandler" class="toc__link nav-link">Example alternate static resource handler: StaticMappedResourceHandler</a>
                    </li>
                
            </ul>
        </div>
    

                

                
                    <nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        
            <li class="breadcrumb-item"><a href="https://docs.laminas.dev/">Overview</a></li>
            <li class="breadcrumb-item"><a href="https://docs.mezzio.dev/">Mezzio</a></li>

            
                <li class="breadcrumb-item"><a href="../..">mezzio-swoole</a></li>

                
                    
                        
                        
                    
                
                    
                        
                        
                            <li class="breadcrumb-item">Reference</li>
                        
                    
                

                <li class="breadcrumb-item active" aria-current="page">Static Resources</li>
            
        
    </ol>
</nav>






    
    
        <h2 class="chapter__headline">Reference</h2>
    

    <h1 id="static-resources">Static Resources</h1>
<p>One feature of a web server is the ability to serve static files from your
filesystem. mezzio-swoole provides that capability as well.</p>
<p>To enable this, the package provides an alternate
<a href="https://docs.laminas.dev/laminas-httphandlerrunner/runner/"><code>RequestHandlerRunner</code></a>
implementation via the class <code>Mezzio\Swoole\SwooleRequestHandlerRunner</code>
that performs two duties:</p>
<ul>
<li>If a static resource is matched, it serves that.</li>
<li>Otherwise, it passes off handling to the composed application pipeline.</li>
</ul>
<p>Internally, the <code>SwooleRequestHandlerRunner</code> composes another class, a
<code>Mezzio\Swoole\StaticResourceHandlerInterface</code> instance. This instance
is passed the Swoole request and response, and returns a value indicating
whether or not it was able to identify and serve a matching static resource.</p>
<p>Our default implementation, <code>Mezzio\Swoole\StaticResourceHandler</code>,
provides an approach that checks an incoming request path against a list of
known extensions, and a configured document root. If the extension matches, it
then checks to see if the file exists in the document root. If it does, it will
serve it.</p>
<div class="admonition info">
<p class="admonition-title">Disabling static resources</p>
<p>By default, we ship with static resource handling enabled.
This is done by having the <code>Mezzio\Swoole\Event\StaticResourceRequestListener</code> in the list of listeners provided for the <code>Mezzio\Swoole\Event\RequestEvent</code>.</p>
<p>To disable that listener, you will need to <strong>replace</strong> the set of listeners for that event, to include only the <code>Mezzio\Swoole\Event\RequestHandlerRequestListener</code>.
You can do that in your application configuration as follows:</p>
<div class="highlight"><pre><span></span><code><span class="x">// in config/autoload/dependencies.global.php:</span>

<span class="x">use Laminas\Stdlib\ArrayUtils\MergeReplaceKey;</span>
<span class="x">use Mezzio\Swoole\Event;</span>

<span class="x">return [</span>
<span class="x">    // ...</span>
<span class="x">    &#39;mezzio-swoole&#39; =&gt; [</span>
<span class="x">        // ...</span>
<span class="x">        &#39;swoole-http-server&#39; =&gt; [</span>
<span class="x">            // ...</span>
<span class="x">            &#39;listeners&#39; =&gt; [</span>
<span class="x">                Event\RequestEvent::class =&gt; new MergeReplaceKey([</span>
<span class="x">                    Event\RequestHandlerRequestListener::class,</span>
<span class="x">                ]),</span>
<span class="x">            ],</span>
<span class="x">        ],</span>
<span class="x">    ],</span>
<span class="x">    // ...</span>
<span class="x">];</span>
</code></pre></div>
</div>
<h2 id="middleware">Middleware</h2>
<p>The <code>StaticResourceHandler</code> implementation performs its work by composing a
queue of middleware to execute when attempting to serve a matched file. Using
this approach, we are able to provide a configurable set of capabilities for
serving static resources. What we currently provide is as follows:</p>
<ul>
<li>
<p><code>CacheControlMiddleware</code> will set a <code>Cache-Control</code> header based on
  configuration you provide it. Configuration uses a combination of regular
  expressions to match against the path, with the <code>Cache-Control</code> directive to
  use when the match occurs.</p>
</li>
<li>
<p><code>ClearStatCacheMiddleware</code> will, if configured to do so, call
  <code>clearstatcache()</code> either on every request, or at specific intervals. This is
  useful if you anticipate filesystem changes in your document root.</p>
</li>
<li>
<p><code>ContentTypeFilterMiddleware</code> checks the incoming filename against a map of
  known extensions and their associated Content-Type values. If it cannot
  match the file, it returns a value indicating no match was found so that the
  application can continue processing the request. Otherwise, it provides the
  Content-Type for the associated response. This middleware is generally best
  used as the outermost layer, to ensure no other middleware executes in the
  case that the file cannot be matched.</p>
</li>
<li>
<p><code>ETagMiddleware</code> will set an <code>ETag</code> header using either a strong or weak
  algorithm, and only on files matching given regular expressions. If the <code>ETag</code>
  header value matches either an <code>If-Match</code> or <code>If-None-Match</code> request header,
  it will provide a response status of <code>304</code> and disable sending content.</p>
</li>
<li>
<p><code>GzipMiddleware</code> detects the <code>Accept-Encoding</code> request header and, if present,
  and the compression level provided to the instance allows, it will compress
  the returned response content using either gzip or deflate compression as
  requested.</p>
</li>
<li>
<p><code>HeadMiddleware</code> will force an empty response. (The status and headers may be
  set by other middleware.)</p>
</li>
<li>
<p><code>LastModifiedMiddleware</code> will set a <code>Last-Modified</code> header using the
  <code>filemtime()</code> value of the requested resource. If the header value is later
  than an <code>If-Modified-Since</code>  request header, it will provide a response status
  of <code>304</code> and disable sending content.</p>
</li>
<li>
<p><code>MethodNotAllowedMiddleware</code> will set the response status to <code>405</code>, and set an
  <code>Allow</code> header indicating the allowed methods when an unsupported request
  method is provided.</p>
</li>
<li>
<p><code>OptionsMiddleware</code> will force an empty response with an <code>Allow</code> header set
  to the allowed methods. (Other headers may also be present!)</p>
</li>
</ul>
<p>By default, these are registered in the following order, contingent on
configuration being provided:</p>
<ul>
<li><code>ContentTypeFilterMiddleware</code></li>
<li><code>MethodNotAllowedMiddleware</code></li>
<li><code>OptionsMiddleware</code></li>
<li><code>HeadMiddleware</code></li>
<li><code>GzipMiddleware</code></li>
<li><code>ClearStatCacheMiddleware</code></li>
<li><code>CacheControlMiddleware</code></li>
<li><code>LastModifiedMiddleware</code></li>
<li><code>ETagMiddleware</code></li>
</ul>
<p>This approach ensures that the most expensive operations are never called unless
other conditions are met (e.g., if the HTTP request method is not allowed,
there's no need to calculate the <code>Last-Modified</code> or <code>ETag</code> headers); it also
ensures that all possible headers are provided whenever possible (e.g., a <code>HEAD</code>
request should also expose <code>Cache-Control</code>, <code>Last-Modified</code>, and <code>ETag</code>
headers).</p>
<blockquote>
<h3 id="providing-your-own-middleware">Providing your own middleware</h3>
<p>If you want to disable middleware, or to provide an alternate list of middleware
(including your own!), you will need to provide an alternate
<code>StaticResourceHandler</code> factory. In most cases, you can extend
<code>StaticResourceHandlerFactory</code> and override the <code>configureMiddleware(array
$config) : array</code> method to do so. Be sure to remember to add a <code>dependencies</code>
setting mapping the <code>StaticResourceHandlerInterface</code> service to your new factory
when done!</p>
</blockquote>
<h2 id="configuration">Configuration</h2>
<p>We provide a factory for the <code>StaticResourceHandler</code> that uses a
configuration-driven approach in order to:</p>
<ul>
<li>Set the document root.</li>
<li>Set the map of allowed extensions to content-types.</li>
<li>Configure and provide middleware.</li>
</ul>
<p>The following demonstrates all currently available configuration options:</p>
<div class="highlight"><pre><span></span><code><span class="x">// config/autoload/swoole.local.php</span>

<span class="x">return [</span>
<span class="x">    &#39;mezzio-swoole&#39; =&gt; [</span>
<span class="x">        &#39;swoole-http-server&#39; =&gt; [</span>
<span class="x">            &#39;static-files&#39; =&gt; [</span>
<span class="x">                // Since 2.1.0: Set to false to disable any serving of static</span>
<span class="x">                // files; all other configuration will then be ignored.</span>
<span class="x">                &#39;enable&#39; =&gt; true,</span>

<span class="x">                // Document root; defaults to &quot;getcwd() . &#39;/public&#39;&quot;</span>
<span class="x">                &#39;document-root&#39; =&gt; &#39;/path/to/static/files/to/serve&#39;,</span>

<span class="x">                // Extension =&gt; content-type map.</span>
<span class="x">                // Keys are the extensions to map (minus any leading `.`),</span>
<span class="x">                // values are the MIME type to use when serving them.</span>
<span class="x">                // A default list exists if none is provided.</span>
<span class="x">                &#39;type-map&#39; =&gt; [],</span>

<span class="x">                // How often a worker should clear the filesystem stat cache.</span>
<span class="x">                // If not provided, it will never clear it. The value should be</span>
<span class="x">                // an integer indicating the number of seconds between clear</span>
<span class="x">                // operations. 0 or negative values will clear on every request.</span>
<span class="x">                &#39;clearstatcache-interval&#39; =&gt; 3600,</span>

<span class="x">                // Which ETag algorithm to use.</span>
<span class="x">                // Must be one of &quot;weak&quot; or &quot;strong&quot;; the default, when none is</span>
<span class="x">                // provided, is &quot;weak&quot;.</span>
<span class="x">                &#39;etag-type&#39; =&gt; &#39;weak|strong&#39;,</span>

<span class="x">                // gzip options</span>
<span class="x">                &#39;gzip&#39; =&gt; [</span>
<span class="x">                    // Compression level to use.</span>
<span class="x">                    // Should be an integer between 1 and 9; values less than 1</span>
<span class="x">                    // disable compression.</span>
<span class="x">                    &#39;level&#39; =&gt; 4,</span>
<span class="x">                ],</span>

<span class="x">                // Rules governing which server-side caching headers are emitted.</span>
<span class="x">                // Each key must be a valid regular expression, and should match</span>
<span class="x">                // typically only file extensions, but potentially full paths.</span>
<span class="x">                // When a static resource matches, all associated rules will apply.</span>
<span class="x">                &#39;directives&#39; =&gt; [</span>
<span class="x">                    &#39;regex&#39; =&gt; [</span>
<span class="x">                        &#39;cache-control&#39; =&gt; [</span>
<span class="x">                            // one or more valid Cache-Control directives:</span>
<span class="x">                            // - must-revalidate</span>
<span class="x">                            // - no-cache</span>
<span class="x">                            // - no-store</span>
<span class="x">                            // - no-transform</span>
<span class="x">                            // - public</span>
<span class="x">                            // - private</span>
<span class="x">                            // - max-age=\d+</span>
<span class="x">                        ],</span>
<span class="x">                        &#39;last-modified&#39; =&gt; bool, // Emit a Last-Modified header?</span>
<span class="x">                        &#39;etag&#39; =&gt; bool, // Emit an ETag header?</span>
<span class="x">                    ],</span>
<span class="x">                ],</span>
<span class="x">            ],</span>
<span class="x">        ],</span>
<span class="x">    ],</span>
<span class="x">];</span>
</code></pre></div>
<blockquote>
<h3 id="security-warning">Security warning</h3>
<p>Never add <code>php</code> as an allowed static file extension, as doing so could expose
the source code of your PHP application!</p>
<h3 id="document-root">Document root</h3>
<p>If no <code>document_root</code> configuration is present, the default is to use
<code>getcwd() . '/public'</code>. If either the configured or default document root
does not exist, we raise an exception.</p>
<h3 id="default-extensioncontent-types">Default extension/content-types</h3>
<p>By default, we serve files with extensions in the whitelist defined in the
constant <code>Mezzio\Swoole\StaticResourceHandler\ContentTypeFilterMiddleware::DEFAULT_STATIC_EXTS</code>,
which is derived from a <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Basics_of_HTTP/MIME_types/Complete_list_of_MIME_types">list of common web MIME types maintained by Mozilla</a>.</p>
</blockquote>
<h3 id="configuration-example">Configuration Example</h3>
<p>The example which follows provides the following options:</p>
<ul>
<li>Sets the document root to <code>/var/www/htdocs</code>.</li>
<li>Adds a custom extension / content-type map.</li>
<li>Provides a clearstatcache interval of 2 hours.</li>
<li>Selects the "strong" ETag algorithm.</li>
<li>Indicates a gzip compression level of 3.</li>
<li>Sets Cache-Control, Last-Modified, and ETag directives for JS, CSS, and image files.</li>
<li>Sets Cache-Control directives for plain text files.</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="x">// config/autoload/swoole.local.php</span>

<span class="x">return [</span>
<span class="x">    &#39;mezzio-swoole&#39; =&gt; [</span>
<span class="x">        &#39;swoole-http-server&#39; =&gt; [</span>
<span class="x">            &#39;static-files&#39; =&gt; [</span>
<span class="x">                &#39;enable&#39;        =&gt; true,</span>
<span class="x">                &#39;document-root&#39; =&gt; &#39;/var/www/htdocs&#39;,</span>

<span class="x">                &#39;type-map&#39; =&gt; [</span>
<span class="x">                    &#39;css&#39;   =&gt; &#39;text/css&#39;,</span>
<span class="x">                    &#39;gif&#39;   =&gt; &#39;image/gif&#39;,</span>
<span class="x">                    &#39;ico&#39;   =&gt; &#39;image/x-icon&#39;,</span>
<span class="x">                    &#39;jpg&#39;   =&gt; &#39;image/jpg&#39;,</span>
<span class="x">                    &#39;jpeg&#39;  =&gt; &#39;image/jpg&#39;,</span>
<span class="x">                    &#39;js&#39;    =&gt; &#39;application/javascript&#39;,</span>
<span class="x">                    &#39;png&#39;   =&gt; &#39;image/png&#39;,</span>
<span class="x">                    &#39;svg&#39;   =&gt; &#39;image/svg+xml&#39;,</span>
<span class="x">                    &#39;txt&#39;   =&gt; &#39;text/plain&#39;,</span>
<span class="x">                ],</span>

<span class="x">                &#39;clearstatcache-interval&#39; =&gt; 7200,</span>

<span class="x">                &#39;etag-type&#39; =&gt; &#39;strong&#39;,</span>

<span class="x">                &#39;gzip&#39; =&gt; [</span>
<span class="x">                    &#39;level&#39; =&gt; 3,</span>
<span class="x">                ],</span>

<span class="x">                &#39;directives&#39; =&gt; [</span>
<span class="x">                    &#39;/\.(css|gif|ico|jpg|jpeg|png|svg|js)$/&#39; =&gt; [</span>
<span class="x">                        &#39;cache-control&#39; =&gt; [</span>
<span class="x">                            &#39;public&#39;,</span>
<span class="x">                            &#39;no-transform&#39;,</span>
<span class="x">                        ],</span>
<span class="x">                        &#39;last-modified&#39; =&gt; true,</span>
<span class="x">                        &#39;etag&#39; =&gt; true,</span>
<span class="x">                    ],</span>
<span class="x">                    &#39;/\.txt$/&#39; =&gt; [</span>
<span class="x">                        &#39;cache-control&#39; =&gt; [</span>
<span class="x">                            &#39;public&#39;,</span>
<span class="x">                            &#39;no-cache&#39;,</span>
<span class="x">                        ],</span>
<span class="x">                    ],</span>
<span class="x">                ],</span>
<span class="x">            ],</span>
<span class="x">        ],</span>
<span class="x">    ],</span>
<span class="x">];</span>
</code></pre></div>
<h2 id="writing-middleware">Writing Middleware</h2>
<p>Static resource middleware must implement
<code>Mezzio\Swoole\StaticResourceHandler\MiddlewareInterface</code>, which
defines the following:</p>
<div class="highlight"><pre><span></span><code><span class="x">namespace Mezzio\Swoole\StaticResourceHandler;</span>

<span class="x">use Swoole\Http\Request;</span>

<span class="x">interface MiddlewareInterface</span>
<span class="x">{</span>
<span class="x">    /**</span>
<span class="x">     * @param string $filename The discovered filename being returned.</span>
<span class="x">     * @param callable $next has the signature:</span>
<span class="x">     *     function (Request $request, string $filename) : StaticResourceResponse</span>
<span class="x">     */</span>
<span class="x">    public function __invoke(</span>
<span class="x">        Request $request,</span>
<span class="x">        string $filename,</span>
<span class="x">        callable $next</span>
<span class="x">    ) : StaticResourceResponse;</span>
<span class="x">}</span>
</code></pre></div>
<p>The <code>$next</code> argument has the following signature:</p>
<div class="highlight"><pre><span></span><code><span class="x">namespace Mezzio\Swoole\StaticResourceHandler;</span>

<span class="x">use Swoole\Http\Request;</span>

<span class="x">public function __invoke(</span>
<span class="x">    Request $request,</span>
<span class="x">    string $filename</span>
<span class="x">) : StaticResourceResponse;</span>
</code></pre></div>
<p>Typically, middleware will look something like this:</p>
<div class="highlight"><pre><span></span><code><span class="x">$response = $next($request, $filename);</span>

<span class="x">// if some request condition does not match:</span>
<span class="x">// return $response;</span>

<span class="x">// Otherwise, manipulate the returned $response instance and then return it.</span>
</code></pre></div>
<p>Middleware either produces or manipulates a
<code>Mezzio\Swoole\StaticResourceHandler\StaticResourceResponse</code> instance.
That class looks like the following:</p>
<div class="highlight"><pre><span></span><code><span class="x">class StaticResourceResponse</span>
<span class="x">{</span>
<span class="x">    /**</span>
<span class="x">     * @param callable $responseContentCallback Callback to use when emitting</span>
<span class="x">     *     the response body content via Swoole. Must have the signature:</span>
<span class="x">     *     function (SwooleHttpResponse $response, string $filename) : void</span>
<span class="x">     */</span>
<span class="x">    public function __construct(</span>
<span class="x">        int $status = 200,</span>
<span class="x">        array $headers = [],</span>
<span class="x">        bool $sendContent = true,</span>
<span class="x">        callable $responseContentCallback = null</span>
<span class="x">    );</span>

<span class="x">    public function addHeader(string $name, string $value) : void;</span>

<span class="x">    public function disableContent() : void;</span>

<span class="x">    /**</span>
<span class="x">     * Call this method to indicate that the request cannot be served as a</span>
<span class="x">     * static resource. The request runner will then proceed to execute</span>
<span class="x">     * the associated application in order to generate the response.</span>
<span class="x">     */</span>
<span class="x">    public function markAsFailure() : void;</span>

<span class="x">    /**</span>
<span class="x">     * @param callable $responseContentCallback Callback to use when emitting</span>
<span class="x">     *     the response body content via Swoole. Must have the signature:</span>
<span class="x">     *     function (SwooleHttpResponse $response, string $filename) : void</span>
<span class="x">     */</span>
<span class="x">    public function setResponseContentCallback(callable $callback) : void;</span>

<span class="x">    /**</span>
<span class="x">     * Use this within a response content callback to set the associated</span>
<span class="x">     * Content-Length of the generated response. Loggers can then query</span>
<span class="x">     * for this information in order to provide that information in the logs.</span>
<span class="x">     */</span>
<span class="x">    public function setContentLength(int $length) : void;</span>

<span class="x">    public function setStatus(int $status) : void;</span>
<span class="x">}</span>
</code></pre></div>
<p>Most middleware will conditionally set the status, one or more headers, and
potentially disable returning the response body (via <code>disableContent()</code>).
Middleware that restricts access or filters out specific files will also use
<code>markAsFailure()</code>.</p>
<blockquote>
<h3 id="providing-an-alternative-mechanism-for-sending-response-content">Providing an alternative mechanism for sending response content</h3>
<p>In some cases, you may want to alter how the <code>Swoole\Http\Response</code> receives the
body content. By default, we use <code>Swoole\Http\Response::sendfile()</code>. However,
this may not work well when performing tasks such as compression, appending a
watermark, etc. As an example, the <code>GzipMiddleware</code> adds a compression filter to
a filehandle representing the file to send, and then calls
<code>Swoole\Http\Response::write()</code> in a loop until all content is sent.</p>
<p>To perform work like this, you can call the
<code>StaticResourceResponse::setResponseContentCallback()</code> method as detailed in the
section above within your middleware.</p>
</blockquote>
<h2 id="alternative-static-resource-handlers">Alternative static resource handlers</h2>
<p>As noted at the beginning of this chapter, the <code>SwooleRequestHandlerRunner</code>
composes a <code>StaticResourceHandlerInterface</code> instance in order to determine if a
resource was matched by the request, and then to serve it.</p>
<p>If you want to provide an alternative mechanism for doing so (e.g., to serve
files out of a caching server), you will need to implement
<code>Mezzio\Swoole\StaticResourceHandlerInterface</code>:</p>
<div class="highlight"><pre><span></span><code><span class="x">declare(strict_types=1);</span>

<span class="x">namespace Mezzio\Swoole;</span>

<span class="x">use Swoole\Http\Request as SwooleHttpRequest;</span>
<span class="x">use Swoole\Http\Response as SwooleHttpResponse;</span>

<span class="x">interface StaticResourceHandlerInterface</span>
<span class="x">{</span>
<span class="x">    /**</span>
<span class="x">     * Attempt to process a static resource based on the current request.</span>
<span class="x">     *</span>
<span class="x">     * If the resource cannot be processed, the method should return null.</span>
<span class="x">     * Otherwise, it should return the StaticResourceResponse that was used</span>
<span class="x">     * to send the Swoole response instance. The runner can then query this</span>
<span class="x">     * for content length and status.</span>
<span class="x">     */</span>
<span class="x">    public function processStaticResource(</span>
<span class="x">        SwooleHttpRequest $request,</span>
<span class="x">        SwooleHttpResponse $response</span>
<span class="x">    ) : ?StaticResourceHandler\StaticResourceResponse;</span>
<span class="x">}</span>
</code></pre></div>
<p>Once implemented, map the service
<code>Mezzio\Swoole\StaticResourceHandlerInterface</code> to a factory that
returns your custom implementation within your <code>dependencies</code> configuration.</p>
<h2 id="example-alternate-static-resource-handler-staticmappedresourcehandler">Example alternate static resource handler: StaticMappedResourceHandler</h2>
<ul>
<li>Since 2.7.0</li>
</ul>
<p>The default static resource handler, <code>Mezzio\Swoole\StaticResourceHandler</code>, requires all files to be in the specified document root directory (by default, "public") when instantiating the handler.
If you are using modules generating templates with associated file assets (JavaScript, CSS, etc.), those files must be copied to the "public" directory if you wish to allow access to them.
This can be done via scripting, but is one more step to consider when testing or deploying a site.
Ideally, a module should be able to contain both its template and any dependencies that template relies upon.</p>
<p>For example, assume you have a module, AwesomeModule, with a handler called "HomeHandler", which renders the 'home' template.
You designate the prefix, <code>/awesome-home</code> for rendering the assets.
The structure of your module files looks like this:</p>
<div class="highlight"><pre><span></span><code>AwesomeModule
├── src
|   ├── Handler
|   |   ├── HomeHandler.php
|   |   ├── HomeHandlerFactory.php
|   ├── ConfigProvider.php
├── templates
│   ├── home
|   |   ├── home.html
|   |   ├── style.css
│   ├── layouts
</code></pre></div>
<p>In your <code>home.html</code> template, you can refer to the <code>style.css</code> file, using <code>/awesome-home</code> as follows:</p>
<div class="highlight"><pre><span></span><code><span class="p">&lt;</span><span class="nt">link</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;/awesome-home/style.css&quot;</span> <span class="na">rel</span><span class="o">=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;text/css&quot;</span><span class="p">&gt;</span>
</code></pre></div>
<p>Currently, however, this will cause errors, as the stylesheet will not be available under the <code>public/</code> tree of the application.
You would need to copy or symlink the files to the appropriate location to make that work.</p>
<p>The <code>StaticMappedResourceHandler</code> solves this problem.</p>
<h3 id="using-staticmappedresourcehandler">Using StaticMappedResourceHandler</h3>
<p>To use <code>Mezzio\Swoole\StaticMappedResourceHandler</code> from an application or module:</p>
<ol>
<li>Define what your URI prefix will be (e.g., <code>/awesome-home</code>).</li>
<li>Update references to linkable resources in your templates to use the desired prefix (e.g., <code>&lt;script src='/awesome-home/style.css'&gt;&lt;/script&gt;</code>).</li>
<li>In your application/module configuration (or <code>ConfigProvider</code>), add the relationship between your prefix (<code>awesome-home</code>) and any directories containing the assets.</li>
<li>In the application's configuration, set the alias of <code>Mezzio\Swoole\StaticResourceHandlerInterface</code> to use <code>Mezzio\Swoole\StaticMappedResourceHandler</code>.</li>
</ol>
<p>For step #3, in your module's ConfigProvider, you can add a configuration setting as follows:</p>
<div class="highlight"><pre><span></span><code><span class="x">    public function __invoke() : array</span>
<span class="x">    {</span>
<span class="x">        return [</span>
<span class="x">            &#39;config&#39; =&gt; [</span>
<span class="x">                &#39;mezzio-swoole&#39; =&gt; [</span>
<span class="x">                    &#39;swoole-http-server&#39; =&gt; [</span>
<span class="x">                        &#39;static-files&#39; =&gt; [</span>
<span class="x">                            &#39;mapped-document-roots&#39; =&gt; [</span>
<span class="x">                                &#39;awesome-home&#39; =&gt; __DIR__ . &#39;/../../templates/home&#39;</span>
<span class="x">                            ]</span>
<span class="x">                        ]</span>
<span class="x">                    ]</span>
<span class="x">                ]</span>
<span class="x">            ]</span>
<span class="x">        ];</span>
<span class="x">    }</span>
</code></pre></div>
<p>Note that prefixes are always the first part after the host, and specifying the initial slash is optional (i.e. <code>awsesome-home</code> and <code>/awesome-home</code> both work and represent the same thing).</p>
<p>In step #4, in your application's configuration (<code>autoload/dependencies.global.php</code> is a good place), override the default implementation of <code>StaticResourceHandlerInterface</code>:</p>
<div class="highlight"><pre><span></span><code><span class="x">return [</span>
<span class="x">    &#39;dependencies&#39; =&gt; [</span>
<span class="x">        &#39;aliases&#39; =&gt; [</span>
<span class="x">            Mezzio\Swoole\StaticResourceHandlerInterface::class =&gt; Mezzio\Swoole\StaticMappedResourceHandler::class</span>
<span class="x">            // Fully\Qualified\ClassOrInterfaceName::class =&gt; Fully\Qualified\ClassName::class,</span>
<span class="x">        ],</span>
<span class="x">        // etc.</span>
</code></pre></div>
<p>For step #3, an alternative to storing a configuration is dynamically associating <code>/awesome-home</code> to a directory in code (probably within a factory).
This approach could be useful if the directory of the assets isn't know until runtime.</p>
<div class="highlight"><pre><span></span><code><span class="x">use Psr\Container\ContainerInterface;</span>
<span class="x">use Mezzio\Template\TemplateRendererInterface;</span>
<span class="x">use Mezzio\Swoole\StaticResourceHandler\FileLocationRepositoryInterface;</span>

<span class="x">class AwesomeHomeHandlerFactory</span>
<span class="x">{</span>
<span class="x">    public function __invoke(ContainerInterface $container) : DocumentationViewHandler</span>
<span class="x">    {</span>
<span class="x">        // Establish location for the home template assets</span>
<span class="x">        $repo = $container-&gt;get(FileLocationRepositoryInterface::class);</span>
<span class="x">        $repo-&gt;addMappedDocumentRoot(</span>
<span class="x">            &#39;awesome-home&#39;,</span>
<span class="x">            realpath(__DIR__ . &#39;/../../templates/home&#39;)</span>
<span class="x">        );</span>

<span class="x">        return new AwesomeHomeHandler(</span>
<span class="x">            $container-&gt;get(TemplateRendererInterface::class)</span>
<span class="x">        );</span>
<span class="x">    }</span>
<span class="x">}</span>
</code></pre></div>
<p>When the template renders, the client will request <code>/awesome-home/style.css</code>, which the <code>StaticMappedResourceHandler</code> will now retrieve from the <code>templates/home/</code> folder of the module.</p>
<p><code>Mezzio\Swoole\StaticMappedResourceHandler</code> uses the <code>Mezzio\Swoole\StaticResourceHandler\FileLocationRepository</code> (which implements <code>Mezzio\Swoole\StaticResourceHandler\FileLocationRepositoryInterface</code>) to maintain an association of URI prefixes with file directories.
If you require using a file location that requires authentication, decompression, etc. you can override the default functionality by creating your own implementation of <code>Mezzio\Swoole\StaticResourceHandler\FileLocationRepositoryInterface</code>.</p>




    <nav>
    <ul class="page-nav hidden-print">

        
        <li class="page-nav__item">
            
                <a rel="prev" class="page-nav__link page-nav__link--prev" href="../events/">
                    <i class="fa fa-chevron-left"></i> Previous
                </a>
            
        </li>

        
        <li class="page-nav__item">
            
                <a rel="next" class="page-nav__link page-nav__link--next" href="../logging/">
                    Next <i class="fa fa-chevron-right"></i>
                </a>
            
        </li>
    </ul>
</nav>



                
            </div>
            <div class="col-md-3 col-sm-12 sidebar">
                <div class="donation-banner">
    <a href="https://getlaminas.org/support/">
        <h2>Donate</h2>
        <p>Support Laminas Developers Directly</p>
        <img src="https://funding.communitybridge.org/assets/cb-f-horizontal-white.svg">
    </a>
</div>

                
                    <div class="component-selector">
    
    <h5 class="component-selector__subtitle">Find documentation…</h5>
    <select class="form-control component-selector__control">
        <option value="/">Overview</option>
        <optgroup label="Components"></optgroup>
    </select>
</div>
                    
    <div class="subnavigation hidden-print">
        <h4 class="subnavigation__title">
            <a href="../..">mezzio-swoole</a>
        </h4>

        <h5 class="subnavigation__subtitle">Table of Contents</h5>

        <ul class="subnavigation__list">
            

                
                
                    
                        
    <li class="subnavigation__list-item ">
        <a href="../intro/" class="subnavigation__link">Introduction</a>
    </li>

                    
                        
    <li class="subnavigation__list-item">
        <span class="subnavigation__headline">Reference</span>
        <ul class="subnavigation__list">
            
                
    <li class="subnavigation__list-item ">
        <a href="../events/" class="subnavigation__link">Swoole HTTP Server Events</a>
    </li>

            
                
    <li class="subnavigation__list-item subnavigation__list-item--active">
        <a href="./" class="subnavigation__link">Static Resources</a>
    </li>

            
                
    <li class="subnavigation__list-item ">
        <a href="../logging/" class="subnavigation__link">Logging</a>
    </li>

            
                
    <li class="subnavigation__list-item ">
        <a href="../async-tasks/" class="subnavigation__link">Async Tasks</a>
    </li>

            
                
    <li class="subnavigation__list-item ">
        <a href="../table/" class="subnavigation__link">Using Swoole Tables</a>
    </li>

            
                
    <li class="subnavigation__list-item ">
        <a href="../hot-code-reload/" class="subnavigation__link">Hot Code Reloading</a>
    </li>

            
                
    <li class="subnavigation__list-item ">
        <a href="../command-line/" class="subnavigation__link">Command Line Tooling</a>
    </li>

            
                
    <li class="subnavigation__list-item ">
        <a href="../how-it-works/" class="subnavigation__link">How it works</a>
    </li>

            
                
    <li class="subnavigation__list-item ">
        <a href="../considerations/" class="subnavigation__link">Considerations when using Swoole</a>
    </li>

            
        </ul>
    </li>

                    
                        
    <li class="subnavigation__list-item">
        <span class="subnavigation__headline">Cookbook</span>
        <ul class="subnavigation__list">
            
                
    <li class="subnavigation__list-item ">
        <a href="../cookbook/static-resource-listener-removal/" class="subnavigation__link">Removing the StaticResourceRequestListener</a>
    </li>

            
                
    <li class="subnavigation__list-item ">
        <a href="../cookbook/swoole-not-starting/" class="subnavigation__link">Swoole-based server always returns home page</a>
    </li>

            
        </ul>
    </li>

                    
                        
    <li class="subnavigation__list-item ">
        <a href="../migration/" class="subnavigation__link">Migration</a>
    </li>

                    
                
            

                
                

                    
                    
                
            

                
                

                    
                    
                
            

                
                

                    
                    
                
            
        </ul>
    </div>

                    
                
            </div>
        </div>
    </div>

    
    <footer class="footer">
    <div class="container">

        
        <div class="row">
            <div class="col-md-12 text-center">
                <a class="footer__button" href="#page-top"><i class="fa fa-chevron-up" aria-hidden="true"></i></a>
            </div>
        </div>

        <div class="row">
            <div class="col-md-12">
                <h5>Laminas</h5>
                <ul>
                    <li>Laminas Project <a href="https://getlaminas.org/">The new foundation for the community-supported, open source continuation of Zend Framework</a></li>
                    <li>Laminas Components and MVC <a href="https://docs.laminas.dev/">Components and MVC for enterprise applications</a></li>
                    <li>Mezzio <a href="https://docs.mezzio.dev/">PSR-15 middleware in minutes</a></li>
                    <li>Laminas API Tools <a href="https://api-tools.getlaminas.org/">Build RESTful APIs in minutes</a></li>
                </ul>
            </div>
        </div>

        <div class="row">
            <div class="col-md-12">
                <div class="row">

                    
                    <div class="col-md-4">
                        <h4 class="footer__headline">Support</h4>
                        <ul class="support__list">
                            <li class="support__list-item">
                                <a href="https://discourse.laminas.dev" class="support__link" title="Forum"><i class="fa fa-comments"></i></a>
                            </li>
                            <li class="support__list-item">
                                <a href="https://laminas.dev/chat" class="support__link" title="Chat"><i class="fa fa-slack"></i></a>
                            </li>
                            <li class="support__list-item">
                                <a href="https://github.com/laminas" class="support__link" title="Github"><i class="fa fa-github"></i></a>
                            </li>
                            <li class="support__list-item">
                                <a href="https://twitter.com/getlaminas" class="support__link" title="Twitter"><i class="fa fa-twitter"></i></a>
                            </li>
                            <li class="support__list-item">
                                <a href="https://getlaminas.org/blog/rss.xml" class="support__link" title="Blog feed"><i class="fa fa-rss"></i></a>
                            </li>
                            <li class="support__list-item">
                                <a href="https://getlaminas.org/security/feed" class="support__link" title="Security feed"><i class="fa fa-rss-square"></i></a>
                            </li>
                        </ul>
                    </div>

                    
                    <div class="col-md-4">
                        <h4 class="footer__headline">License</h4>
                        <p>
                            Code licensed under <a
                                href="https://github.com/mezzio/mezzio-swoole/blob/master/LICENSE.md">BSD 3-Clause</a>.
                        </p>
                    </div>

                    
                    <div class="col-md-4">
                        <h4 class="footer__headline">Copyright</h4>
                        <p>
                            <!--Built with love by the Laminas team with the help of our
                            <a href="https://github.com/mezzio/mezzio-swoole/graphs/contributors">contributors</a>.<br>-->
                            &copy; 2021 <a href="https://getlaminas.org/">Laminas Project</a> a Series of LF Projects, LLC.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</footer>

    <script>
        let base_url = '../..',
            project  = "mezzio",
            siteName = 'mezzio-swoole';
    </script>
    <script src="https://docs.laminas.dev/js/scripts.js"></script>
    
        <script src="../../search/main.js"></script>
    

    
    <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Search</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                    <span class="sr-only">Close</span>
                </button>
            </div>
            <div class="modal-body">
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search in mezzio-swoole" id="mkdocs-search-query">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
        </div>
    </div>
</div>
</body>


</html>
